(function(){var e,t,r,n,u,a,s,i,c,o,l,f,h,y,p,$,g,d,m,v,k,b,w,x,O,j=[].slice,q=[].indexOf||function(e){for(var t=0,r=this.length;r>t;t++)if(t in this&&this[t]===e)return t;return-1},A={}.hasOwnProperty;for($=this,b={},k=function(){var e;return e={},["every","some","filter","reduce","map"].forEach(function(t){return e[t]=function(){var e,r;return r=arguments[0],e=2<=arguments.length?j.call(arguments,1):[],r[t].apply(r,e)}}),e.keys=Object.keys,e.isArray=Array.isArray,e.result=function(e,t){return null==e&&(e={}),"Function"===b.getType(e[t])?e[t]():e[t]},e.detect=function(e,t){var r,n,u;for(n=0,u=e.length;u>n;n++)if(r=e[n],t(r))return r},e.reject=function(e,t){var r,n,u,a;for(a=[],n=0,u=e.length;u>n;n++)r=e[n],t(r)||a.push(r);return a},e.intersection=function(e,t){var r,n,u,a;for(a=[],n=0,u=e.length;u>n;n++)r=e[n],-1!==t.indexOf(r)&&a.push(r);return a},e.isEqual=function(e,t){return JSON.stringify(e)===JSON.stringify(t)},e},n=function(e){var t,r,n,u;for(u=["every","some","filter","detect","reject","reduce","intersection","isEqual","keys","isArray","result","map"],r=0,n=u.length;n>r;r++)if(t=u[r],b[t]=e[t],!b[t])throw new Error(""+t+" missing. Please ensure that you first initialize underscore-query with either lodash or underscore")},b.getType=function(e){var t;return t=Object.prototype.toString.call(e).substr(8),t.substr(0,t.length-1)},b.makeObj=function(e,t){var r;return(r={})[e]=t,r},b.reverseString=function(e){return e.toLowerCase().split("").reverse().join("")},b.compoundKeys=["$and","$not","$or","$nor"],b.makeGetter=function(e){return e=e.split("."),function(t){var r,n,u,a;for(n=t,u=0,a=e.length;a>u;u++)r=e[u],n&&(n=b.result(n,r));return n}},c=function(e,t){var r,n,u;u=[];for(r in t)n=t[r],u.push(b.makeObj(e,b.makeObj(r,n)));return u},l=function(e){var t,r,n,u,a,s;switch(t=b.keys(e)[0],u=e[t],r={key:t},-1!==t.indexOf(".")&&(r.getter=b.makeGetter(t)),n=b.getType(u)){case"RegExp":case"Date":r.type="$"+n.toLowerCase(),r.value=u;break;case"Object":if(q.call(b.compoundKeys,t)>=0)r.type=t,r.value=h(u),r.key=null;else if(b.keys(u).length>1)r.type="$and",r.value=h(c(t,u)),r.key=null;else for(a in u)if(A.call(u,a)){if(s=u[a],!v(a,s))throw new Error("Query value ("+s+") doesn't match query type: ("+a+")");switch(r.type=a,a){case"$elemMatch":r.value=d(f(s));break;case"$endsWith":r.value=b.reverseString(s);break;case"$likeI":case"$startsWith":r.value=s.toLowerCase();break;case"$computed":r=l(b.makeObj(t,s)),r.getter=b.makeGetter(t);break;default:r.value=s}}break;default:r.type="$equal",r.value=u}return"$equal"!==r.type||"Object"!==n&&"Array"!==n||(r.type="$deepEqual"),r},h=function(e){var t,r,n,u,a,s,i;for(n=b.isArray(e)?e:function(){var r;r=[];for(t in e)A.call(e,t)&&(u=e[t],r.push(b.makeObj(t,u)));return r}(),i=[],a=0,s=n.length;s>a;a++)r=n[a],i.push(l(r));return i},v=function(e,t){var r;switch(r=b.getType(t),e){case"$in":case"$nin":case"$all":case"$any":return"Array"===r;case"$size":return"Number"===r;case"$regex":case"$regexp":return"RegExp"===r;case"$like":case"$likeI":return"String"===r;case"$between":case"$mod":return"Array"===r&&2===t.length;case"$cb":return"Function"===r;default:return!0}},m=function(e,t){var r;switch(r=b.getType(t),e){case"$like":case"$likeI":case"$regex":case"$startsWith":case"$endsWith":return"String"===r;case"$contains":case"$all":case"$any":case"$elemMatch":return"Array"===r;case"$size":return"String"===r||"Array"===r;case"$in":case"$nin":return null!=t;default:return!0}},y=function(e,t,r,n,u){switch(e){case"$equal":return b.isArray(r)?q.call(r,t)>=0:r===t;case"$deepEqual":return b.isEqual(r,t);case"$contains":return q.call(r,t)>=0;case"$ne":return r!==t;case"$lt":return t>r;case"$gt":return r>t;case"$lte":return t>=r;case"$gte":return r>=t;case"$between":return t[0]<r&&r<t[1];case"$betweene":return t[0]<=r&&r<=t[1];case"$in":return q.call(t,r)>=0;case"$nin":return q.call(t,r)<0;case"$all":return b.every(t,function(e){return q.call(r,e)>=0});case"$any":return b.some(r,function(e){return q.call(t,e)>=0});case"$size":return r.length===t;case"$exists":case"$has":return null!=r===t;case"$like":return-1!==r.indexOf(t);case"$likeI":return-1!==r.toLowerCase().indexOf(t);case"$startsWith":return 0===r.toLowerCase().indexOf(t);case"$endsWith":return 0===b.reverseString(r).indexOf(t);case"$type":return typeof r===t;case"$regex":case"$regexp":return t.test(r);case"$cb":return t.call(n,r);case"$mod":return r%t[0]===t[1];case"$elemMatch":return g(r,t,null,!0);case"$and":case"$or":case"$nor":case"$not":return p(e,t,u,n);default:return!1}},d=function(e,t){var r;return"String"===b.getType(t)&&(r=t,t=function(e,t){return e[r](t)}),function(r){var n,u,a;for(u=0,a=e.length;a>u;u++)if(n=e[u],!p(n.type,n.parsedQuery,t,r))return!1;return!0}},p=function(e,t,r,n){var u,a,s,i,c,o;for(a=0,c=0,o=t.length;o>c;c++)switch(s=t[c],u=s.getter?s.getter(n,s.key):r?r(n,s.key):n[s.key],i=m(s.type,u),i&&(i=y(s.type,s.value,u,n,r)),i&&a++,e){case"$and":if(!i)return!1;break;case"$not":if(i)return!1;break;case"$or":if(i)return!0;break;case"$nor":if(i)return!1;break;default:throw new Error("Invalid compound method")}return"$not"===e?0===a:"$or"!==e},f=function(e){var t,r,n,u,a;if(n=b.keys(e),!n.length)return[];if(t=b.intersection(b.compoundKeys,n),0===t.length)return[{type:"$and",parsedQuery:h(e)}];if(t.length!==n.length){q.call(t,"$and")<0&&(e.$and={},t.unshift("$and"));for(r in e)A.call(e,r)&&(a=e[r],q.call(b.compoundKeys,r)<0&&(e.$and[r]=a,delete e[r]))}return function(){var r,n,a;for(a=[],r=0,n=t.length;n>r;r++)u=t[r],a.push({type:u,parsedQuery:h(e[u])});return a}()},o=function(e){var t;return"String"===b.getType(e)&&(t=e,e=function(e,r){return e[t](r)}),e},e=function(){function e(e,t){this.items=e,this._getter=t,this.theQuery={}}return e.prototype.all=function(e,t){return e&&(this.items=e),e=this.indexes?this.getIndexedItems(this.items):this.items,g(e,this.theQuery,this._getter,t)},e.prototype.chain=function(){return _.chain(this.all.apply(this,arguments))},e.prototype.tester=function(){return i(this.theQuery,this._getter)},e.prototype.first=function(e){return this.all(e,!0)},e.prototype.getter=function(e){return this._getter=e,this},e}(),t=function(e){return function(t,r){var n;return r&&(t=b.makeObj(t,r)),null==(n=this.theQuery)[e]&&(n[e]=[]),this.theQuery[e].push(t),this}},O=b.compoundKeys,w=0,x=O.length;x>w;w++)s=O[w],e.prototype[s.substr(1)]=t(s);return e.prototype.find=e.prototype.query=e.prototype.run=e.prototype.all,r=function(t,r){return new e(t,r)},i=function(e,t){return d(f(e),o(t))},a=function(e,t,r){return g(e,t,r,!0)},g=function(e,t,n,u){var a;return arguments.length<2?r.apply(this,arguments):(n&&(n=o(n)),"Function"!==b.getType(t)&&(t=d(f(t),n)),(a=u?b.detect:b.filter)(e,t))},g.build=r,g.parse=f,g.findOne=g.first=a,g.tester=g.testWith=i,g.getter=g.pluckWith=b.makeGetter,u=function(e,t){return null==t&&(t=!0),e||(e=k(),t=!1),n(e),t&&e.mixin({query:g,q:g}),g},$._?u($._):exports&&("undefined"!=typeof module&&null!==module?module.exports:void 0)?module.exports=u:u}).call(this);