(function(e){var r,t,n,a,u,s,c,i,l,o,$,f,y,p,h,d,g=[].indexOf||function(e){for(var r=0,t=this.length;t>r;r++)if(r in this&&this[r]===e)return r;return-1},v={}.hasOwnProperty;for(y=e("underscore"),f={},d=["every","some","filter","reject","reduce","intersection","isEqual","keys","isArray","result"],p=0,h=d.length;h>p;p++)n=d[p],f[n]=y[n];f.getType=function(e){var r;return r=Object.prototype.toString.call(e).substr(8),r.substr(0,r.length-1)},f.makeObj=function(e,r){var t;return(t={})[e]=r,t},f.getNested=function(e){return function(r){var t,a,u;for(t=r,a=0,u=e.length;u>a;a++)n=e[a],t&&(t=t[n]);return t}},f.reverseString=function(e){return e.toLowerCase().split("").reverse().join("")},f.compoundKeys=["$and","$not","$or","$nor"],f.seperator=".",f.$computedGetter=function(e,r){return"function"==typeof e[r]?e[r]():void 0},u=function(e){var r,t,a,i,l;switch(n=f.keys(e)[0],a=e[n],r={key:n},-1!==n.indexOf(f.seperator)&&(r.getter=f.getNested(n.split(f.seperator))),t=f.getType(a)){case"RegExp":case"Date":r.type="$"+t.toLowerCase(),r.value=a;break;case"Object":if(g.call(f.compoundKeys,n)>=0)r.type=n,r.value=c(a),r.key=null;else for(i in a){if(l=a[i],!$(i,l))throw Error("Query value doesn't match query type: "+i+": "+l);switch(r.type=i,i){case"$elemMatch":r.value=s(l);break;case"$endsWith":r.value=f.reverseString(l);break;case"$likeI":case"$startsWith":r.value=l.toLowerCase();break;case"$computed":r=u(f.makeObj(n,l)),r.getter=f.$computedGetter;break;default:r.value=l}}break;default:r.type="$equal",r.value=a}return"$equal"!==r.type||"Object"!==t&&"Array"!==t||(r.type="$deepEqual"),r},c=function(e){var r,t,a,s,c,i;for(t=f.isArray(e)?e:function(){var r;r=[];for(n in e)v.call(e,n)&&(a=e[n],r.push(f.makeObj(n,a)));return r}(),i=[],s=0,c=t.length;c>s;s++)r=t[s],i.push(u(r));return i},$=function(e,r){var t;switch(t=f.getType(r),e){case"$in":case"$nin":case"$all":case"$any":return"Array"===t;case"$size":return"Number"===t;case"$regex":case"$regexp":return"RegExp"===t;case"$like":case"$likeI":return"String"===t;case"$between":case"$mod":return"Array"===t&&2===r.length;case"$cb":return"Function"===t;default:return!0}},o=function(e,r){var t;switch(t=f.getType(r),e){case"$like":case"$likeI":case"$regex":case"$startsWith":case"$endsWith":return"String"===t;case"$contains":case"$all":case"$any":case"$elemMatch":return"Array"===t;case"$size":return"String"===t||"Array"===t;case"$in":case"$nin":return null!=r;default:return!0}},i=function(e,r,n,a,u){switch(e){case"$equal":return f.isArray(n)?g.call(n,r)>=0:n===r;case"$deepEqual":return f.isEqual(n,r);case"$contains":return g.call(n,r)>=0;case"$ne":return n!==r;case"$lt":return r>n;case"$gt":return n>r;case"$lte":return r>=n;case"$gte":return n>=r;case"$between":return n>r[0]&&r[1]>n;case"$betweene":return n>=r[0]&&r[1]>=n;case"$in":return g.call(r,n)>=0;case"$nin":return 0>g.call(r,n);case"$all":return f.every(r,function(e){return g.call(n,e)>=0});case"$any":return f.some(n,function(e){return g.call(r,e)>=0});case"$size":return n.length===r;case"$exists":case"$has":return null!=n===r;case"$like":return-1!==n.indexOf(r);case"$likeI":return-1!==n.toLowerCase().indexOf(r);case"$startsWith":return 0===n.toLowerCase().indexOf(r);case"$endsWith":return 0===f.reverseString(n).indexOf(r);case"$type":return typeof n===r;case"$regex":case"$regexp":return r.test(n);case"$cb":return r.call(a,n);case"$mod":return n%r[0]===r[1];case"$elemMatch":return l(n,r,null,!0).length>0;case"$and":case"$or":case"$nor":case"$not":return 1===t([a],r,e,u).length;default:return!1}},t=function(e,r,t,n){var a,u;return u="$and"===t||"$or"===t?f.filter:f.reject,a="$or"===t||"$nor"===t,u(e,function(e){var t,u,s,c,l;for(c=0,l=r.length;l>c;c++)if(u=r[c],t=u.getter?u.getter(e,u.key):n?n(e,u.key):e[u.key],s=o(u.type,t),s&&(s=i(u.type,u.value,t,e,n)),a===s)return a;return!a})},s=function(e){var r,t,a,u;if(t=f.keys(e),r=f.intersection(f.compoundKeys,t),0===r.length)return[{type:"$and",parsedQuery:c(e)}];if(r.length!==t.length){0>g.call(r,"$and")&&(e.$and={},r.unshift("$and"));for(n in e)v.call(e,n)&&(u=e[n],0>g.call(f.compoundKeys,n)&&(e.$and[n]=u,delete e[n]))}return function(){var t,n,u;for(u=[],t=0,n=r.length;n>t;t++)a=r[t],u.push({type:a,parsedQuery:c(e[a])});return u}()},r=function(e,r,t){var a,u,s,c,i;for(a={items:e,getter:r,isParsed:t,theQuery:{}},a.all=a.find=a.query=a.run=function(e,r,t){return null==e&&(e=a.items),null==r&&(r=a.getter),null==t&&(t=a.isParsed),l(e,a.theQuery,r,t)},a.first=function(){var e;return null!=(e=a.all.apply(this,arguments))?e[0]:void 0},a.chain=function(){return y.chain(a.all.apply(this,arguments))},i=f.compoundKeys,u=function(e){var r;return r=e.substr(1),a[r]=function(r,t){var n,u;return t&&(r=f.makeObj(r,t)),null==(u=(n=a.theQuery)[e])&&(n[e]=[]),a.theQuery[e].push(r),a}},s=0,c=i.length;c>s;s++)n=i[s],u(n);return a},a=function(e,r){var t;return t=s(e),function(e){return f.isArray(e)||(e=[e]),l(e,t,r,!0).length===e.length}},l=function(e,n,a,u){var c,i;return 2>arguments.length?r.apply(this,arguments):(u||(n=s(n)),"String"===f.getType(a)&&(c=a,a=function(e,r){return e[c](r)}),i=function(e,r){return t(e,r.parsedQuery,r.type,a)},f.reduce(n,i,e))},l.build=r,l.parse=s,l.tester=a,y.mixin({query:l})}).call(this,"undefined"!=typeof exports?require:function(e){return this["underscore"===e?"_":e]});